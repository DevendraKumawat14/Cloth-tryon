<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ModelSwap Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Use Inter font */
        body {
            font-family: 'Inter', sans-serif;
        }
        
        /* Custom styles for the file input */
        input[type="file"]::file-selector-button {
            @apply bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg cursor-pointer hover:bg-blue-700 transition-colors duration-200;
        }

        /* Simple loading spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #3B82F6; /* blue-500 */
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Custom message box */
        #messageBox {
            @apply fixed top-0 left-1/2 -translate-x-1/2 p-4 bg-red-600 text-white rounded-b-lg shadow-lg opacity-0 transition-all duration-300 -translate-y-full;
        }
        
        #messageBox.show {
            @apply opacity-100 translate-y-0;
        }

        /* Custom select arrow */
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239CA3AF' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-6xl bg-gray-800 shadow-2xl rounded-2xl p-8 md:p-12">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white">AI ModelSwap Studio</h1>
            <p class="text-lg text-gray-400 mt-2">Swap models across multiple photos at once with a description.</p>
        </header>

        <main class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-12">
            
            <div class="flex flex-col space-y-6">
                
                <div>
                    <label for="imageUpload" class="block text-xl font-semibold mb-3 text-white">1. Upload Original Photos (Multiple)</label>
                    <input type="file" id="imageUpload" accept="image/png, image/jpeg" class="w-full text-sm text-gray-300 file:mr-4 file:border-0 file:outline-none focus:outline-none" multiple>
                    
                    <div id="originalImagePreviewArea" class="mt-4 w-full h-40 bg-gray-700 rounded-lg flex flex-col p-4 border-2 border-dashed border-gray-600 overflow-y-auto">
                        <span id="originalPreviewPlaceholder" class="text-gray-400 m-auto">File list will appear here</span>
                        </div>
                </div>
                
                <div>
                    <label class="block text-xl font-semibold mb-3 text-white">2. Define New Model</label>
                    
                    <label for="modelPresetSelect" class="block text-lg font-medium mb-2 text-gray-300">Select a Preset Model (Optional)</label>
                    <select id="modelPresetSelect" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-600 mb-2">
                        <option value="">-- Select a preset --</option>
                        </select>

                    <div class="w-full flex justify-center mb-4">
                        <img id="modelPresetPreview" src="" alt="Model preview" class="hidden w-24 h-24 object-cover rounded-lg bg-gray-700 border border-gray-600">
                    </div>
                    
                    <label for="modelDescription" class="block text-lg font-medium mb-2 text-gray-300">Describe the Desired Model</label>
                    <textarea id="modelDescription" rows="4" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-600" placeholder="e.g., 'A professional-looking woman with long brown hair, smiling brightly', or 'A strong male model with short dark hair and a serious expression'."></textarea>
                </div>
                
                <div>
                    <label for="backgroundImageUpload" class="block text-xl font-semibold mb-3 text-white">3. (Optional) Change Background</label>
                    <input type="file" id="backgroundImageUpload" accept="image/png, image/jpeg" class="w-full text-sm text-gray-300 file:mr-4 file:border-0 file:outline-none focus:outline-none">
                    
                    <div class="mt-4 w-full h-40 bg-gray-700 rounded-lg flex items-center justify-center border-2 border-dashed border-gray-600 overflow-hidden">
                        <img id="backgroundImagePreview" src="" alt="Background image preview" class="hidden h-full w-full object-contain">
                        <span id="backgroundPreviewPlaceholder" class="text-gray-400">Background preview</span>
                    </div>
                </div>

                <div>
                    <button id="generateBtn" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-lg hover:bg-blue-700 transition-colors duration-200 flex items-center justify-center space-x-2 disabled:opacity-50">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.301 24.301 0 014.5 0m0 0v5.714c0 .597.237 1.17.659 1.591L19 14.5m-4.5-11.396c.251.023.501.05.75.082M19 14.5v.218c0 .13.02.258.058.385a1.81 1.81 0 01-2.427 2.053M19 14.5A2.25 2.25 0 0016.75 12.25h-1.5a2.25 2.25 0 00-2.25 2.25v.218A2.25 2.25 0 0112 16.75c-2.42 0-4.398 1.978-4.398 4.398s1.978 4.398 4.398 4.398 4.398-1.978 4.398-4.398M19 14.5c.13.02.258.058.385.058a1.81 1.81 0 002.053-2.427M5 14.5v.218c0 .13-.02.258-.058.385a1.81 1.81 0 002.427 2.053M5 14.5A2.25 2.25 0 017.25 12.25h1.5a2.25 2.25 0 012.25 2.25v.218A2.25 2.25 0 0012 16.75c2.42 0 4.398 1.978 4.398 4.398s-1.978 4.398-4.398 4.398-4.398-1.978-4.398-4.398M5 14.5c-.13.02-.258.058-.385.058a1.81 1.81 0 01-2.053-2.427" />
                        </svg>
                        <span>Swap Models</span>
                    </button>
                </div>
            </div>
            
            <div class="flex flex-col space-y-6">
                <label class="block text-xl font-semibold mb-3 text-white">4. Results Gallery</label>
                
                <div id="outputContainer" class="w-full min-h-[28rem] bg-gray-700 rounded-lg flex flex-col p-4 border-2 border-gray-600 overflow-y-auto">
                    <div id="loadingSpinner" class="spinner hidden mx-auto my-auto"></div>
                    <span id="outputPlaceholder" class="text-gray-400 m-auto">Your new images will appear here</span>
                </div>
            </div>
        </main>
    </div>
    
    <div id="messageBox">
        <span id="messageText"></span>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="config.js"></script>

    <script type="module">
        // --- 0. Model Preset Data ---
        // (Using placeholder images. Replace with your actual image URLs)
        const modelPresets = [
            {
                name: " Rugged Man (Beard)",
                prompt: "A rugged Caucasian male with a short beard and green eyes, textured skin.",
                preview: "src/images/m1.png"
            },
            {
                name: "Youthfull smiling man (curly hair)",
                prompt: "A young Caucasian male model with curly blonde hair and a friendly smile.",
                preview: "src/images/m2.png"
            },
            {
                name: "Handsome Caucassian male (clean shaven)",
                prompt: "handsome Caucasian male model with short brown hair and blue eyes, clean-shaven",
                preview: "src/images/m3.png"
            },
            {
                name: "Sophisticated Woman (long wavy blonde hair)",
                prompt: "A 25-year-old Caucasian female with long wavy blonde hair, blue eyes, and fair, flawless skin. Symmetrical facial features, professional photoshoot, hyperrealistic, 8k.",
                preview: "src/images/f1.png"
            }
            ,
            {
                name: "Young Woman (Sharp blonde bob)",
                prompt: "A Caucasian female model with a sharp blonde bob, piercing green eyes, and strong cheekbones. Porcelain skin, elegant neck, hyperrealistic, editorial photoshoot lighting.",
                preview: "src/images/f2.png"
            }
        ];

        // --- 1. DOM Elements ---
        const imageUpload = document.getElementById('imageUpload');
        const originalImagePreviewArea = document.getElementById('originalImagePreviewArea');
        const originalPreviewPlaceholder = document.getElementById('originalPreviewPlaceholder');
        
        // Elements for target model definition
        const modelDescription = document.getElementById('modelDescription');
        const modelPresetSelect = document.getElementById('modelPresetSelect'); // New
        const modelPresetPreview = document.getElementById('modelPresetPreview'); // New

        // Elements for background image (New)
        const backgroundImageUpload = document.getElementById('backgroundImageUpload');
        const backgroundImagePreview = document.getElementById('backgroundImagePreview');
        const backgroundPreviewPlaceholder = document.getElementById('backgroundPreviewPlaceholder');

        // Output elements
        const generateBtn = document.getElementById('generateBtn');
        const outputContainer = document.getElementById('outputContainer');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const outputPlaceholder = document.getElementById('outputPlaceholder');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');

        // State variables
        let originalImageBase64List = [];
        let backgroundImageBase64 = null; // New

        // --- 2. Populate Preset Dropdown on Load ---
        document.addEventListener('DOMContentLoaded', () => {
            modelPresets.forEach(preset => {
                const option = document.createElement('option');
                option.value = preset.prompt;
                option.textContent = preset.name;
                option.dataset.previewSrc = preset.preview; // Store preview URL
                modelPresetSelect.appendChild(option);
            });
        });

        // --- 3. Original Images Upload and Preview ---
        imageUpload.addEventListener('change', async (event) => {
            const files = event.target.files;
            if (!files || files.length === 0) {
                originalImageBase64List = [];
                originalImagePreviewArea.innerHTML = ''; // Clear preview area
                originalImagePreviewArea.appendChild(originalPreviewPlaceholder);
                originalPreviewPlaceholder.classList.remove('hidden');
                return;
            }

            originalImageBase64List = [];
            originalImagePreviewArea.innerHTML = ''; // Clear preview area
            originalPreviewPlaceholder.classList.add('hidden');
            
            const filePromises = Array.from(files).map(file => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const base64Data = e.target.result.split(',')[1];
                        
                        // Create preview element
                        const previewWrapper = document.createElement('div');
                        previewWrapper.className = 'flex items-center p-2 bg-gray-600 rounded-lg mb-2';
                        const previewImg = document.createElement('img');
                        previewImg.src = e.target.result;
                        previewImg.className = 'w-12 h-12 object-cover rounded-md mr-3';
                        const fileName = document.createElement('span');
                        fileName.textContent = file.name;
                        fileName.className = 'text-sm text-gray-200 truncate';
                        
                        previewWrapper.appendChild(previewImg);
                        previewWrapper.appendChild(fileName);
                        
                        resolve({ base64Data, previewElement: previewWrapper });
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            });

            try {
                const results = await Promise.all(filePromises);
                results.forEach(result => {
                    originalImageBase64List.push(result.base64Data);
                    originalImagePreviewArea.appendChild(result.previewElement);
                });
            } catch (error) {
                console.error("Error reading files:", error);
                showMessage("There was an error reading some files.");
            }
        });
        
        // --- 4. (New) Background Image Upload and Preview ---
        backgroundImageUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                backgroundImageBase64 = null;
                backgroundImagePreview.classList.add('hidden');
                backgroundPreviewPlaceholder.classList.remove('hidden');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                backgroundImagePreview.src = e.target.result;
                backgroundImagePreview.classList.remove('hidden');
                backgroundPreviewPlaceholder.classList.add('hidden');
                // Store the base64 data *without* the "data:image/jpeg;base64," prefix
                backgroundImageBase64 = e.target.result.split(',')[1];
            };
            reader.readAsDataURL(file);
        });

        // --- 5. (New) Preset Dropdown Change ---
        modelPresetSelect.addEventListener('change', (event) => {
            const selectedOption = event.target.options[event.target.selectedIndex];
            const prompt = selectedOption.value;
            const previewSrc = selectedOption.dataset.previewSrc;

            modelDescription.value = prompt; // Set textarea value

            if (previewSrc) {
                modelPresetPreview.src = previewSrc;
                modelPresetPreview.classList.remove('hidden');
            } else {
                modelPresetPreview.classList.add('hidden');
                modelPresetPreview.src = '';
            }
        });

        // --- 6. (Updated) Clear preset if description is manually typed ---
        modelDescription.addEventListener('input', () => {
            if (modelDescription.value.trim() !== modelPresetSelect.value) {
                // If description is typed and doesn't match the preset, clear the preset
                modelPresetSelect.value = ''; 
                modelPresetPreview.classList.add('hidden');
                modelPresetPreview.src = '';
            }
        });

        // --- 7. Show Custom Error Message ---
        function showMessage(message) {
            messageText.textContent = message;
            messageBox.classList.add('show');
            
            // Hide message after 3 seconds
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000);
        }

        // --- 8. (Updated) Generate Button Click ---
        generateBtn.addEventListener('click', async () => {
            // Validation
            if (originalImageBase64List.length === 0) {
                showMessage("Please upload at least one original image.");
                return;
            }
            // Ensure description is provided
            if (modelDescription.value.trim() === '') {
                showMessage("Please describe the desired model or select a preset.");
                return;
            }

            // Set loading state
            setLoading(true);
            let hasFailures = false;

            for (const originalBase64 of originalImageBase64List) {
                try {
                    const resultBase64 = await callGeminiApi(originalBase64);
                    if (resultBase64) {
                        appendResultToGallery(resultBase64);
                    } else {
                        hasFailures = true;
                        appendErrorToGallery("An image failed to process. See console for details.");
                    }
                } catch (error) {
                    hasFailures = true;
                    appendErrorToGallery(`An error occurred: ${error.message}`);
                }
            }
            
            setLoading(false);
            
            if (hasFailures) {
                showMessage("Some images failed to process.");
            }
        });

        // --- 9. Set Loading State ---
        function setLoading(isLoading) {
            if (isLoading) {
                generateBtn.disabled = true;
                generateBtn.classList.add('opacity-50');
                // Clear output container and show spinner
                outputContainer.innerHTML = ''; 
                outputContainer.appendChild(loadingSpinner);
                loadingSpinner.classList.remove('hidden');
                outputPlaceholder.classList.add('hidden');
            } else {
                generateBtn.disabled = false;
                generateBtn.classList.remove('opacity-50');
                loadingSpinner.classList.add('hidden');
                
                // If no images were generated, show the placeholder again
                if (outputContainer.children.length === 1 && outputContainer.firstChild === loadingSpinner) {
                     outputContainer.innerHTML = ''; // Clear spinner
                     outputContainer.appendChild(outputPlaceholder);
                     outputPlaceholder.classList.remove('hidden');
                }
            }
        }

        // --- 10. (Updated) Call Gemini API with Exponential Backoff ---
        async function callGeminiApi(originalBase64, retryCount = 0) {
            const apiKey = GEMINI_API_KEY ; // Leave blank for now, should be server-side for production
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image:generateContent?key=${apiKey}`; // Note: Updated model name
            
            let systemPrompt = `You are an expert e-commerce photo editor. You will be given a 'SOURCE' image (containing the clothes and pose) and instructions for the desired model.
            
**CRITICAL RULES:**
1.  **DO NOT** change the clothes, outfit, or apparel from the 'SOURCE' image. The clothes must remain exactly the same.
2.  **DO NOT** change the pose from the 'SOURCE' image.
`;

            const parts = [];
            
            // Add background rule and new background image (if provided)
            if (backgroundImageBase64) {
                // If background image is provided, change the rule
                systemPrompt += "3.  **DO** change the background. Place the model and clothes into the 'NEW BACKGROUND' image provided. Make it look realistic.";
                
                parts.push({ text: "This is the 'SOURCE' image:" });
                parts.push({
                    inlineData: {
                        mimeType: "image/jpeg",
                        data: originalBase64 
                    }
                });
                
                parts.push({ text: "This is the 'NEW BACKGROUND' image:" });
                parts.push({
                    inlineData: {
                        mimeType: "image/jpeg",
                        data: backgroundImageBase64
                    }
                });
            } else {
                // If no background image, keep original rule
                systemPrompt += "3.  **DO NOT** change the background from the 'SOURCE' image.";

                parts.push({ text: "This is the 'SOURCE' image:" });
                parts.push({
                    inlineData: {
                        mimeType: "image/jpeg",
                        data: originalBase64 
                    }
                });
            }

            // Add the system prompt at the very beginning
            parts.unshift({ text: systemPrompt });

            // Add the model description
            parts.push({ text: `Generate a new model with the following characteristics for the SOURCE image: ${modelDescription.value.trim()}` });


            const payload = {
                contents: [{ parts: parts }],
                generationConfig: {
                    // responseMimeType: "image/png" // Use this for models that support it
                },
                // safetySettings: [...] // Add safety settings if needed
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if ((response.status === 429 || response.status >= 500) && retryCount < 3) {
                        const delay = Math.pow(2, retryCount) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return callGeminiApi(originalBase64, retryCount + 1); // Retry
                    }
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                // Updated path for Gemini 1.5 Flash
                const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                if (base64Data) {
                    return base64Data; // Return the data for the gallery
                } else {
                    const errorText = result?.candidates?.[0]?.finishReason || "No image generated. The prompt might have been blocked.";
                    console.error("API Error:", result); // Log the full result
                    return null; // Return null on failure
                }

            } catch (error) {
                console.error("API Call Error:", error);
                return null; // Return null on failure
            }
        }
        
        // --- 11. Function to add results to the gallery ---
        function appendResultToGallery(base64Data) {
            const imageUrl = `data:image/png;base64,${base64Data}`;
            
            const wrapper = document.createElement('div');
            wrapper.className = 'relative p-2 bg-gray-600 rounded-lg mb-4';
            
            const img = document.createElement('img');
            img.src = imageUrl;
            img.className = 'w-full h-auto object-contain rounded-md';
            
            const downloadLink = document.createElement('a');
            downloadLink.href = imageUrl;
            downloadLink.download = `swapped-model-${Date.now()}.png`;
            downloadLink.className = 'absolute bottom-4 right-4 bg-green-600 text-white font-bold py-2 px-4 rounded-lg text-sm hover:bg-green-700 transition-colors duration-200 flex items-center space-x-2';
            downloadLink.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg> <span>Download</span>`;
            
            wrapper.appendChild(img);
            wrapper.appendChild(downloadLink);
            outputContainer.appendChild(wrapper);
            // Scroll to bottom to show new results
            outputContainer.scrollTop = outputContainer.scrollHeight;
        }
        
        // --- 12. Function to add error messages to the gallery ---
        function appendErrorToGallery(message) {
            const errorEl = document.createElement('p');
            errorEl.className = 'text-red-400 text-center p-4 bg-gray-800 rounded-lg mb-4';
            errorEl.textContent = message;
            outputContainer.appendChild(errorEl);
            outputContainer.scrollTop = outputContainer.scrollHeight;
        }

    </script>
</body>
</html>